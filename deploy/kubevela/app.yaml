apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  name: frontend-api
  namespace: phrases
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  components:
    - name: frontend-api
      type: webservice
      properties:
        labels:
          app: frontend-api
        image: ghcr.io/adhatcher/frontend_api:6ad10ccb46132177254270b191f7fcf49d85dc0e
        memory: 80Mi
        cpu: "0.08"
        port: 8080
        topologySpreadConstraints:
          - maxSkew: 1
            topologyKey: kubernetes.io/hostname
            whenUnsatisfiable: ScheduleAnyway
            labelSelector:
              matchLabels:
                app: frontend-api
        env:
          - name: ENVIRONMENT
            value: production
      traits:
        - type: scaler
          properties:
            replicas: 1
        - type: hpa
          properties:
            targetAPIVersion: apps/v1
            targetKind: Deployment
            max: 4
            min: 1
            cpu:
              type: Utilization
              value: 80
            mem:
              type: Utilization
              value: 90
        - type: startup-probe
          properties:
            containerName: "frontend-api"
            httpGet:
              path: /healthz
              port: 8080
            periodSeconds: 4
            failureThreshold: 4 
            initialDelaySeconds: 20
        - type: health-probes
          properties:
            livenessProbe:
              httpGet:
                path: /healthz
                port: 8080
              initialDelaySeconds: 20
              periodSeconds: 10
              timeoutSeconds: 2
              failureThreshold: 3
            readinessProbe:
              httpGet:
                path: /healthz
                port: 8080
              initialDelaySeconds: 20
              periodSeconds: 5
              timeoutSeconds: 2
              failureThreshold: 3
        - type: storage
          properties:
            configMap:
              - name: frontend-config
                mountOnly: false
                data:
                  FLASK_HOST: "0.0.0.0"
                  FLASK_PORT: "8080"
                  API_HOST: "backend"
                  API_PORT: "7070"
                mountToEnvs:
                  - envName: FLASK_HOST
                    configMapKey: FLASK_HOST
                  - envName: FLASK_PORT
                    configMapKey: FLASK_PORT
                  - envName: API_HOST
                    configMapKey: API_HOST
                  - envName: API_PORT
                    configMapKey: API_PORT
        - type: expose
          properties:
            type: ClusterIP
            matchLabels:
              app: frontend-api
            ports:
              - name: http
                port: 8080
                protocol: TCP
        - type: httproute
          properties:
            routeName: frontend-api-route
            hostname: phrases.zeus
            service:
              name: frontend-api
              port: 8080
    - name: frontend-api-pdb
      type: k8s-objects
      properties:
        objects:
          - apiVersion: policy/v1
            kind: PodDisruptionBudget
            metadata:
              name: frontend-api-pdb
              namespace: phrases
            spec:
              maxUnavailable: 1
              selector:
                matchLabels:
                  app: frontend-api
